---
author: Ray Heberer
date: 2017-06-20
linktitle: Interacting with the Spotify API in R
title: Interacting with the Spotify API in R
tags: ["Spotify", "API", "R", "RStudio", "iXperience"]
highlight: true
---

### Introduction

This week at [iXperience](http://ixperience.co.za/) I have been given the freedom to choose a dataset that interests me and perform some analysis. Given my background in music, Spotify seemed like a good choice.

In this post, I will show how to authorize a [Spotify App](https://developer.spotify.com/my-applications/#!/applications) from within R, in the hope that my many trials and errors will benefit others who could potentially be interested in this rich source of data.

### Spotify Web API Authentication

Having worked with the Twitter API last week (check out "@RobertRealGuy" on my [projects](https://rayheberer.netlify.com/projects/) page), I initially hoped that the Spotify API would be equally tractable in R. Unfortunately, while the Twitter API's OAuth process is basically accomplished in one step using the [twitteR package](https://cran.r-project.org/web/packages/twitteR/twitteR.pdf), Spotify has no packages on CRAN just yet, and I was not successful with the two in-development packages I found on GitHub.

Basically, authenticating a Spotify App and then making requests has two steps, instead of one. First, a token must be extracted from the response generated by the POST request in which the client ID and secret are provided. Then, and this is the important bit, that token must be specified as a header in every subsequent request made to the APIs endpoints. At least, that is my understanding.

Anyways, on to the code. I will be loading up a few libraries that will be used further down this post as well.

```
library(httr)
library(magrittr)
library(rvest)
library(ggplot2)

clientID = "aSIfiwOUlD"
secret = "sH0wTH3sEpUBlicLy"

response = POST(
  'https://accounts.spotify.com/api/token',
  accept_json(),
  authenticate(clientID, secret),
  body = list(grant_type = 'client_credentials'),
  encode = 'form',
  verbose()
)

token = content(response)$access_token

```

Because the authorization header in the requests I will be making using this token have to be of a certain form (having the word "bearer"), I assign some formatted text to a new variable.

```
authorization.header = paste0("Bearer ", token)
```

With this, you should be fully equipped to start interacting with the Spotify API. I hope this has solved some difficulties and answered some questions, and if you'd like to stick around, I'll briefly demonstrate what sort of things are possible with the API.

### Data Wrangling

It's instructive to look through the [list of endpoints](https://developer.spotify.com/web-api/endpoint-reference/) Spotify's Web API gives developers access to. Very quickly, one might notice that having a track's ID is quite essential for many of the requests.

Since I wanted the tracks in my dataset to have some sort of significance, I went to [Spotify Charts](https://spotifycharts.com/regional/global/weekly/latest) to pull the weekly top 200 IDs. Now, extracting these IDs is just an exercise in web scraping, and I will leave my code below.

```
weekly.top.songs = read_html("https://spotifycharts.com/regional/global/weekly/latest") %>%
  html_nodes("#content > div > div > div > span > table > tbody > tr > td.chart-table-image > a")

id.start = regexpr("/track/", weekly.top.songs) # seems to always be 7
id.end = regexpr('" target="', weekly.top.songs) # seems to always be 63

top.song.ids = substr(weekly.top.songs, id.start+7, id.end-1)
```

top.song.ids is a character vector with a length of 200. This is what I will looping through to gather data about these tracks using the Spotify API.

### Making API Requests

The endpoints that interested me the most were the ones pertaining audio features and audio analysis. Of course, getting basic information through the tracks-by-ID endpoint also seemed to be a good idea.

Notice how I use that authorization.headers variable I made earlier as the value of the config argument in the GET function (made available throught he [httr package](https://cran.r-project.org/web/packages/httr/index.html)).

Since I want to get results for all 200 ids in my list, I'm also wrapping the call in the lapply function.

```
tracks = lapply(1:200, function(n) {
  GET(url = paste("https://api.spotify.com/v1/tracks/", top.song.ids[n], sep = ""),
                        config = add_headers(authorization = authorization.header))
})

features = lapply(1:200, function(n) {
  GET(url = paste0("https://api.spotify.com/v1/audio-features/", top.song.ids[n]),
               config = add_headers(authorization = authorization.header))
})
```

These return lists of objects of the type "response." Below I will show how I converted the "features" list into a tidy data frame. Though not shown, I went through a similar process with the "tracks" list.

```
features.content = sapply(1:200, function(n) {
  content(features[[n]])
})

features.content = t(features.content)

features.df = cbind(rank = 1:200, rank.desc = 200:1, danceability = features.content[,1], 
                    energy = features.content[,2], key = features.content[,3], 
                    loudness = features.content[,4], mode = features.content[,5],
                    speechiness = features.content[,6], acousticness = features.content[,7],
                    instrumentalness = features.content[,8], liveness = features.content[,9],
                    valence = features.content[,10], tempo = features.content[,11], 
                    duration_ms = features.content[,17], time_signature = features.content[,18])

features.df = features.df %>% as.data.frame

for (i in 1:ncol(features.df)) {
  features.df[,i] = unlist(features.df[,i])
}
```

The appropriate indexes for features.content were found by inspection. The content() function also proved to be invaluable.

### Exploratory Data Analysis Part 1 - Summary Statistics